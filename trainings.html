<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
    <script src="js/theme-preload.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Тренировки</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    // Инициализация TG
    if (window.Telegram && window.Telegram.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }
  </script>
<!-- Monochrome premium layer -->
  <link rel="stylesheet" href="css/mono.tokens.css" />
  <link rel="stylesheet" href="css/mono.components.css" />
</head>
<body class="has-tab-bar mono">

  <div class="container">
    <!-- Шапка страницы -->
    <header class="page-header">
      <div>
        <a href="index.html" class="back-btn">← Назад</a>
        <h1 id="page-title">Ваши тренировки</h1>
      </div>
      <div id="level-badge" class="level-badge">Уровень</div>
    </header>

    <!-- Блок переключения категорий (Фильтр) -->
    <div class="filter-tabs">
      <button class="filter-btn active" data-muscle="all" onclick="filterExercises('all')">Все</button>
      <button class="filter-btn" data-muscle="chest" onclick="filterExercises('chest')">Грудь</button>
      <button class="filter-btn" data-muscle="back" onclick="filterExercises('back')">Спина</button>
      <button class="filter-btn" data-muscle="legs" onclick="filterExercises('legs')">Ноги</button>
      <button class="filter-btn" data-muscle="shoulders" onclick="filterExercises('shoulders')">Плечи</button>
      <button class="filter-btn" data-muscle="arms" onclick="filterExercises('arms')">Руки</button>
      <button class="filter-btn" data-muscle="abs" onclick="filterExercises('abs')">Пресс</button>
      <button class="filter-btn" data-muscle="cardio" onclick="filterExercises('cardio')">Кардио</button>
      <button class="filter-btn" data-muscle="mobility" onclick="filterExercises('mobility')">Мобилити</button>
    </div>

    <!-- Поиск по упражнениям -->
    <div class="search-bar">
      <input id="exercise-search" class="input-search" type="search" placeholder="Поиск упражнений..." autocomplete="off" />
    </div>

    <!-- Контейнер для списка карточек -->
    <div id="workout-list" class="workouts-grid">
      <div class="loading-state">
        <p>Загрузка программы...</p>
      </div>
    </div>
  </div>

  <!-- Подключаем основной скрипт -->
  <script src="js/app.js"></script>
  <script src="js/theme.js"></script>


  <!-- Логика страницы -->
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (typeof window.ensureContentPackLoaded === 'function') {
          await window.ensureContentPackLoaded();
        }
      } catch (_) {}
  
      // Проверяем, что контент-пак загружен перед инициализацией страницы
      if (typeof window.__contentPackState !== 'undefined' && window.__contentPackState.loaded) {
        initTrainingPage();
      } else {
        // Если контент-пак не загружен, ждем его загрузки
        setTimeout(() => {
          if (typeof window.__contentPackState !== 'undefined' && window.__contentPackState.loaded) {
            initTrainingPage();
          } else {
            // Если через 100ms контент-пак все еще не загружен, инициализируем страницу в любом случае
            initTrainingPage();
          }
        }, 100);
      }
  
      // Закрытие по клику вне окна (используем closeExerciseModal из app.js)
      const modal = document.getElementById('exercise-modal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) closeExerciseModal();
        });
      }
    });

    function initTrainingPage() {
      // 1. Получаем уровень из памяти
      const currentLevel = localStorage.getItem('userLevel') || 'beginner';

      // 2. Обновляем бейдж на экране
      const badge = document.getElementById('level-badge');
      const levelNames = {
        beginner: 'Новичок',
        intermediate: 'Средний',
        pro: 'Профи'
      };
      if (badge) badge.textContent = levelNames[currentLevel] || 'Новичок';

      // 3. Рисуем список
      renderWorkoutList('workout-list', 'all', currentLevel, getSearchTerm());

      // 4. Поиск
      const input = document.getElementById('exercise-search');
      if (input && !input.__bound) {
        input.addEventListener('input', () => {
          const active = document.querySelector('.filter-btn.active')?.dataset?.muscle || 'all';
          renderWorkoutList('workout-list', active, currentLevel, getSearchTerm());
        });
        input.__bound = true;
      }
    }

    function getSearchTerm() {
      const el = document.getElementById('exercise-search');
      return el ? el.value : '';
    }

    // Функция фильтрации при нажатии кнопок
    function filterExercises(muscleGroup) {
      const currentLevel = localStorage.getItem('userLevel') || 'beginner';

      // Обновляем активную кнопку
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.muscle === muscleGroup);
      });

      // Перерисовываем список
      renderWorkoutList('workout-list', muscleGroup, currentLevel, getSearchTerm());
    }
  </script>

  <!-- Модальное окно упражнения -->
  <div id="exercise-modal" class="modal-overlay" aria-hidden="true">
    <div class="modal-content">
      <button class="modal-close" onclick="closeExerciseModal()">✕</button>

      <!-- Счетчик подходов -->
      <div id="sets-counter" class="sets-counter">Подход 1 / 3</div>

      <h2 class="modal-title">Название</h2>
      <p class="modal-desc">Описание</p>

      <div class="modal-info-blocks">
        <div class="info-block">
          <span class="label">Вес / Инвентарь</span>
          <span class="value modal-weight">-</span>
        </div>
        <div class="info-block">
          <span class="label">Повторы</span>
          <span class="value modal-reps">-</span>
        </div>
      </div>

      <div class="modal-advice-box">
        <p class="label">Совет тренера:</p>
        <p class="modal-advice" style="color: var(--accent-secondary);">Совет</p>
      </div>

      <!-- Кнопка и Таймер -->
      <div class="timer-container">
        <button id="action-btn" class="start-btn btn-state-primary" onclick="handleWorkoutAction(this)">Начать подход 1</button>

        <div id="timer-block" class="timer-display" style="display:none;">
          <span class="timer-label">Отдых</span>
          <div class="timer-frame">
            <svg class="timer-svg" viewBox="0 0 100 100">
              <circle class="timer-bg" cx="50" cy="50" r="45"></circle>
              <circle class="timer-circle" cx="50" cy="50" r="45"></circle>
            </svg>
            <span id="timer-text" class="timer-text">60</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="js/ui/modal.js"></script>
  <script src="js/ui/bottom-nav.js"></script>
  <script src="js/ui/toast.js"></script>
</body>
</html>
