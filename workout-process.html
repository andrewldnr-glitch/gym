<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
    <script src="js/theme-preload.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Тренировка</title>
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/playlists.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    if (window.Telegram && window.Telegram.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }
  </script>
  <link rel="stylesheet" href="css/redesign.css">
  <link rel="stylesheet" href="css/premium.css">
</head>
<body class="has-tab-bar">

  <div class="container">
    <header class="page-header">
      <div>
        <a href="javascript:void(0)" onclick="exitWorkout()" class="back-btn">← Выход</a>
        <h1 id="page-title">Тренировка</h1>
      </div>
      <div id="level-badge" class="level-badge">Курс</div>
    </header>

    <!-- Музыка: плейлисты (Яндекс Музыка) -->
    <div id="playlist-widget"></div>

<!-- Контейнер для списка -->
    <div id="workout-list" class="workouts-grid">
      <div class="loading-state">
        <p>Загрузка...</p>
      </div>
    </div>

    <!-- Кнопка завершения тренировки (внизу) -->
    <div class="footer-cta">
      <button id="finish-btn" class="start-course-btn btn-state-neutral" onclick="finishWorkoutSession()">
        Завершить тренировку
      </button>
    </div>
  </div>

  <!-- Модалка упражнения -->
  <div id="exercise-modal" class="modal-overlay">
    <div class="modal-content">
      <button class="modal-close" onclick="closeExerciseModal()">✕</button>

      <div id="sets-counter" class="sets-counter">Подход 1 / 3</div>

      <h2 class="modal-title">Название</h2>
      <p class="modal-desc">Описание</p>

      <div class="modal-info-blocks">
        <div class="info-block">
          <span class="label">Вес</span>
          <span class="value modal-weight">-</span>
        </div>
        <div class="info-block">
          <span class="label">Повторы</span>
          <span class="value modal-reps">-</span>
        </div>
      </div>

      <div class="modal-advice-box">
        <p class="label">Совет:</p>
        <p class="modal-advice" style="color: var(--accent-secondary);">-</p>
      </div>

      <div class="timer-container">
        <button id="action-btn" class="start-btn btn-state-primary" onclick="handleWorkoutAction(this)">Начать подход 1</button>

        <div id="timer-block" class="timer-display" style="display:none;">
          <span class="timer-label">Отдых</span>
          <div class="timer-frame">
            <svg class="timer-svg" viewBox="0 0 100 100">
              <circle class="timer-bg" cx="50" cy="50" r="45"></circle>
              <circle class="timer-circle" cx="50" cy="50" r="45"></circle>
            </svg>
            <span id="timer-text" class="timer-text">60</span>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- ВАЖНО: api.js ДО app.js -->
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/playlists.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        if (typeof window.ensureContentPackLoaded === 'function') {
          await window.ensureContentPackLoaded();
        }
      } catch (_) {}
  
      // Проверяем, что контент-пак загружен перед инициализацией страницы
      if (typeof window.__contentPackState !== 'undefined' && window.__contentPackState.loaded) {
        initWorkoutProcessPage();
      } else {
        // Если контент-пак не загружен, ждем его загрузки
        setTimeout(() => {
          if (typeof window.__contentPackState !== 'undefined' && window.__contentPackState.loaded) {
            initWorkoutProcessPage();
          } else {
            // Если через 100ms контент-пак все еще не загружен, инициализируем страницу в любом случае
            initWorkoutProcessPage();
          }
        }, 100);
      }
    });
  
    function initWorkoutProcessPage() {
      const source = localStorage.getItem('currentWorkoutSource');
  
      if (source !== 'course') {
        window.location.href = 'courses.html';
        return;
      }
  
      const courseId = localStorage.getItem('currentCourseId');
      const dayIndexRaw = localStorage.getItem('currentWorkoutDayIndex');
      const dayIndex = parseInt(dayIndexRaw || '0', 10);
      const level = localStorage.getItem('userLevel') || 'beginner';
  
      
      // Музыка (плейлист) — сохраняется для конкретной тренировки курса
      try {
        if (window.Playlists && typeof window.Playlists.mountWidget === 'function') {
          const ctxKey = `course::day:`;
          window.Playlists.mountWidget('playlist-widget', { contextKey: ctxKey, compact: true });
        }
      } catch (e) {
        console.warn('playlist widget mount failed:', e);
      }

// 1) Пытаемся взять конкретные назначения из localStorage (content pack)
      let items = [];
      try {
        items = JSON.parse(localStorage.getItem('currentWorkoutItems') || '[]');
      } catch (_) { items = []; }
  
      const titleFromLS = localStorage.getItem('currentWorkoutTitle');
      if (titleFromLS) {
        document.getElementById('page-title').innerText = titleFromLS;
      }
  
      try {
        if (Array.isArray(items) && items.length) {
          renderWorkoutListByIds('workout-list', items, level);
        } else {
          // fallback: старый формат (берём по courseId/dayIndex)
          const course = (typeof COURSES_DATABASE !== 'undefined')
            ? COURSES_DATABASE.find(c => c.id === courseId)
            : null;
  
          if (course && course.schedule && course.schedule[dayIndex]) {
            const dayData = course.schedule[dayIndex];
            document.getElementById('page-title').innerText = dayData.name || 'Тренировка';
            renderWorkoutListByIds('workout-list', dayData.exercises, level);
          } else {
            window.location.href = 'courses.html';
          }
        }
      } catch (e) {
        console.warn('Init workout-process failed:', e);
        window.location.href = 'courses.html';
      }
  
      // Закрытие по клику вне окна
      const modal = document.getElementById('exercise-modal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === this) closeExerciseModal();
        });
      }
    }

    function exitWorkout() {
      if (confirm("Вы уверены? Прогресс текущей тренировки не сохранится.")) {
        try {
          localStorage.removeItem('currentWorkoutSource');
          localStorage.removeItem('currentWorkoutItems');
          localStorage.removeItem('currentWorkoutTitle');
        } catch (_) {}
        window.location.href = 'courses.html';
      }
    }

    // Защита от двойного нажатия
    let __finishing = false;

    async function finishWorkoutSession() {
      if (__finishing) return;
      __finishing = true;

      const btn = document.getElementById('finish-btn');
      if (btn) {
        btn.disabled = true;
        btn.classList.add('is-loading');
        btn.textContent = 'Сохраняем...';
      }

      const courseId = localStorage.getItem('currentCourseId');
      const dayIndex = parseInt(localStorage.getItem('currentWorkoutDayIndex') || '0', 10);
      const level = localStorage.getItem('userLevel') || 'beginner';

      let itemsCount = 0;
      try { itemsCount = JSON.parse(localStorage.getItem('currentWorkoutItems') || '[]').length; } catch (_) {}

      // payload — полезная инфа для истории
      let payload = {};
      try {
        const course = (typeof COURSES_DATABASE !== 'undefined')
          ? COURSES_DATABASE.find(c => c.id === courseId)
          : null;

        const dayData = course?.schedule?.[dayIndex];
        payload = {
          title: localStorage.getItem('currentWorkoutTitle') || dayData?.name || 'Тренировка',
          courseId,
          dayIndex,
          level,
          itemsCount
        };
      } catch (_) {}

      const finishedAtIso = new Date().toISOString();

      // 1) Локально (кеш)
      try {
        const key = 'trainingHistory';
        const hist = JSON.parse(localStorage.getItem(key) || '[]');
        hist.push({
          date: finishedAtIso,
          source: 'course',
          course_id: courseId,
          day_index: dayIndex,
          level,
          payload
        });
        localStorage.setItem(key, JSON.stringify(hist));
      } catch (e) {
        console.warn('Local trainingHistory save failed:', e);
      }

      // 2) Supabase
      try {
        if (typeof window.apiSyncWorkout === 'function') {
          await window.apiSyncWorkout({
            finished_at: finishedAtIso,
            source: 'course',
            course_id: courseId,
            day_index: dayIndex,
            level,
            payload
          });
          console.log('[sync] workout ok', { courseId, dayIndex, level });
        } else {
          console.warn('[sync] apiSyncWorkout is not a function (js/api.js not loaded?)');
        }
      } catch (e) {
        console.warn('[sync] workout failed:', e);
        // Не блокируем пользователя — локальная запись уже есть
      }

      try {
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.HapticFeedback) {
          window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
        }
      } catch (_) {}

      alert("Тренировка завершена! Отличная работа.");
      localStorage.removeItem('currentWorkoutSource');
      localStorage.removeItem('currentWorkoutItems');
      localStorage.removeItem('currentWorkoutTitle');
      window.location.href = 'courses.html';
    }
  </script>



  <nav class="tab-bar" aria-label="Навигация">
      <a class="tab-item active" href="index.html">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5z"/>
        </svg>
        <span class="tab-label">Главная</span>
      </a>
      <a class="tab-item" href="profile.html">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M4 19V5"/>
          <path d="M4 19H20"/>
          <path d="M8 19v-8"/>
          <path d="M12 19v-12"/>
          <path d="M16 19v-4"/>
        </svg>
        <span class="tab-label">Статистика</span>
      </a>
      <a class="tab-item" href="info.html">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
          <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/>
          <circle cx="12" cy="12" r="4"/>
        </svg>
        <span class="tab-label">Инструменты</span>
      </a>
  </nav>

</body>
</html>
