<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>–ü—Ä–æ—Ñ–∏–ª—å</title>

  <link rel="stylesheet" href="css/style.css">
  <!-- ‚úÖ –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã (OPAL –∞–ø–≥—Ä–µ–π–¥) -->
  <link rel="stylesheet" href="css/profile.css">

  <!-- ‚úÖ Lucide CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>

<body class="has-tab-bar">
  <div class="container">

    <!-- ‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã -->
    <div class="theme-card card">
      <div class="theme-title">
        <strong class="section-title">
          <span class="section-title__icon"><i data-lucide="sun-moon"></i></span>
          –¢–µ–º–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        </strong>
        <span>–°–≤–µ—Ç–ª–∞—è –∏–ª–∏ —Ç—ë–º–Ω–∞—è</span>
      </div>

      <div class="theme-segment" role="tablist" aria-label="Theme">
        <button id="theme-btn-light" type="button">Light</button>
        <button id="theme-btn-dark" type="button">Dark</button>
      </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <h2 class="section-title">
      <span class="section-title__icon"><i data-lucide="bar-chart-3"></i></span>
      –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    </h2>

    <div class="stat-item profile-stat">
      <div>
        <div class="stat-label">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
        <div class="stat-value" id="total-count">0</div>
      </div>

      <div class="profile-stat__right">
        <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω—è—è</div>
        <div id="last-training-date" class="profile-stat__last">-</div>
      </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ -->
    <h3 class="history-title">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
    <div id="history-list" class="history-list">
      <p>–í—ã –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.</p>
    </div>

    <!-- –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
    <div class="achievements-section">
      <div class="section-title-row">
        <h2 class="section-title">
          <span class="section-title__icon"><i data-lucide="trophy"></i></span>
          –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        </h2>
        <a class="section-link" href="achievements.html">–í—Å–µ</a>
      </div>
      <div id="achievements-container" class="badges-grid"></div>
    </div>

    <!-- –í–µ—Å -->
    <div class="weight-section">
      <div class="weight-header">
        <h2 class="section-title">
          <span class="section-title__icon"><i data-lucide="scale"></i></span>
          –î–Ω–µ–≤–Ω–∏–∫ –≤–µ—Å–∞
        </h2>
        <div class="weight-current" id="current-weight-display">-- <small>–∫–≥</small></div>
      </div>

      <div class="chart-container">
        <canvas id="weightChart"></canvas>
      </div>

      <div class="input-weight-group">
        <input type="number" id="weight-input" class="input-weight" placeholder="–í–µ—Å, –∫–≥" step="0.1">
        <button class="btn-add-weight" onclick="addNewWeight()">OK</button>
      </div>
      <div id="weight-history-list"></div>
    </div>

    <!-- –ö–ù–û–ü–ö–ê –ü–û–î–ï–õ–ò–¢–¨–°–Ø -->
    <div class="share-wrap">
      <button class="btn-share-result" onclick="shareResults()">
        <span class="share-icon"><i data-lucide="share-2"></i></span>
        –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
      </button>
    </div>

  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="tab-bar">
    <a href="index.html" class="tab-item">
      <i data-lucide="home"></i>
      <span>–ì–ª–∞–≤–Ω–∞—è</span>
    </a>

    <a href="profile.html" class="tab-item active">
      <i data-lucide="bar-chart-3"></i>
      <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
    </a>

    <a href="info.html" class="tab-item">
      <i data-lucide="sparkles"></i>
      <span>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span>
    </a>
  </nav>

  <!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –°–ö–†–ò–ü–¢–û–í -->
  <script src="js/theme.js"></script>
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
  <script src="js/weight.js"></script>
  <script src="js/achievements.js"></script>
  <script src="js/profile.js"></script>

  <script>
    // ‚úÖ –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å lucide-–∏–∫–æ–Ω–∫–∏
    document.addEventListener('DOMContentLoaded', () => {
      try { if (window.lucide) lucide.createIcons(); } catch (_) {}
    });

    // --- helper: –±–µ–∑–æ–ø–∞—Å–Ω—ã–π JSON.parse
    function safeParse(str, fallback) {
      try { return JSON.parse(str); } catch (e) { return fallback; }
    }

    // --- 1) Bootstrap: –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ —Å Supabase –∏ –ø–æ–ª–æ–∂–∏—Ç—å –≤ localStorage
    async function syncFromSupabaseToLocalStorage() {
      if (typeof apiBootstrap !== 'function') return;

      const initData = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp.initData : '';
      if (!initData) return;

      const data = await apiBootstrap();

      // userStats
      const stats = data && data.stats ? data.stats : {};
      localStorage.setItem('userStats', JSON.stringify({
        totalWorkouts: Number(stats.total_workouts || 0),
        lastTrainingDate: stats.last_training_at || null,
        steps: safeParse(localStorage.getItem('userStats') || '{}', {}).steps || 0,
        calories: safeParse(localStorage.getItem('userStats') || '{}', {}).calories || 0
      }));

      // trainingHistory
      const workouts = Array.isArray(data.workouts) ? data.workouts : [];
      localStorage.setItem('trainingHistory', JSON.stringify(
        workouts.map(w => ({
          date: w.finished_at,
          source: w.source,
          course_id: w.course_id,
          day_index: w.day_index,
          level: w.level,
          payload: w.payload
        }))
      ));
      // weightHistory
      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–∞—Ç—É –∫ YYYY-MM-DD –∏ –∞–∫–∫—É—Ä–∞—Ç–Ω–æ –º–µ—Ä–¥–∂–∏–º —Å –ª–æ–∫–∞–ª—å–Ω—ã–º–∏/–Ω–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏
      const weights = Array.isArray(data.weights) ? data.weights : [];
      const normalizeDateToDay = (v) => {
        const s = String(v || "");
        return s.includes("T") ? s.split("T")[0] : s;
      };

      const remoteChronological = weights.slice().reverse().map(x => ({
        date: normalizeDateToDay(x.measured_at),
        weight: Number(x.weight)
      }));

      const localChronological = safeParse(localStorage.getItem("weightHistory") || "[]", []);
      const pending = safeParse(localStorage.getItem("pendingWeightSync") || "[]", []);

      const byDate = new Map();

      // 1) Remote
      remoteChronological.forEach(it => {
        if (!it || !it.date) return;
        byDate.set(it.date, Number(it.weight));
      });

      // 2) Local (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ remote –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç)
      if (Array.isArray(localChronological)) {
        localChronological.forEach(it => {
          const d = normalizeDateToDay(it && it.date);
          if (!d) return;
          if (!byDate.has(d)) byDate.set(d, Number(it.weight));
        });
      }

      // 3) Pending (–≤—Å–µ–≥–¥–∞ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç)
      if (Array.isArray(pending)) {
        pending.forEach(it => {
          const d = normalizeDateToDay(it && it.date);
          if (!d) return;
          byDate.set(d, Number(it.weight));
        });
      }

      const merged = Array.from(byDate.entries())
        .map(([date, weight]) => ({ date, weight }))
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      localStorage.setItem("weightHistory", JSON.stringify(merged));
    }

    // --- 2) –ó–∞–ø—É—Å–∫ UI
    function runUi() {
      if (typeof updateStats === 'function') updateStats();
      if (typeof initWeightSection === 'function') initWeightSection();
      if (typeof renderAchievements === 'function') renderAchievements();
      if (typeof checkAllAchievements === 'function') checkAllAchievements();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await syncFromSupabaseToLocalStorage();
      } catch (e) {
        console.warn('Supabase bootstrap failed, using local cache:', e);
      } finally {
        runUi();
        try { if (typeof window.flushPendingWeightSync === "function") window.flushPendingWeightSync(); } catch (_) {}
      }
    });

    // --- –®–ê–†–ò–ù–ì
    function shareResults() {
      const weightHistory = typeof getWeightHistory === 'function' ? getWeightHistory() : [];
      const stats = safeParse(localStorage.getItem('userStats') || '{}', {});
      const streak = localStorage.getItem('streak') || 0;

      let currentWeight = '--';
      let weightDiffText = '';

      if (weightHistory && weightHistory.length > 0) {
        const start = weightHistory[0].weight;
        const last = weightHistory[weightHistory.length - 1].weight;
        currentWeight = last;

        if (weightHistory.length > 1) {
          const diff = last - start;
          weightDiffText = diff > 0 ? `(+${diff.toFixed(1)} –∫–≥)` : `(${diff.toFixed(1)} –∫–≥)`;
        }
      }

      const message =
`üèÉ‚Äç‚ôÇÔ∏è –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ FitGym:

üî• –°–µ—Ä–∏—è: ${streak} –¥–Ω–µ–π
‚öñÔ∏è –í–µ—Å: ${currentWeight} –∫–≥ ${weightDiffText}
üëü –®–∞–≥–æ–≤: ${stats.steps || 0}
‚ö°Ô∏è –ö–∞–ª–æ—Ä–∏–π: ${stats.calories || 0}

–ó–∞–Ω–∏–º–∞–π—Å—è —Å–æ –º–Ω–æ–π! @kagym_bot`;

      if (window.Telegram && window.Telegram.WebApp) {
        const encodedMsg = encodeURIComponent(message);
        const shareUrl = `https://t.me/share/url?url=&text=${encodedMsg}`;
        Telegram.WebApp.openTelegramLink(shareUrl);
        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      } else {
        navigator.clipboard.writeText(message);
        alert('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
      }
    }
  </script>
</body>
</html>
