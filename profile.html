<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>–ü—Ä–æ—Ñ–∏–ª—å</title>
  <link rel="stylesheet" href="css/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="has-tab-bar">
  <div class="container">

    <!-- –ë–ª–æ–∫: –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ -->
    <h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
    <div class="stat-item" style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div class="stat-label">–í—Å–µ–≥–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</div>
        <div class="stat-value" id="total-count">0</div>
      </div>
      <div style="text-align:right;">
         <div class="stat-label">–ü–æ—Å–ª–µ–¥–Ω—è—è</div>
         <div id="last-training-date" style="color:var(--text-secondary); font-size:0.9rem;">-</div>
      </div>
    </div>

    <!-- –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫ -->
    <h3 style="margin-top: 20px; margin-bottom: 10px;">–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
    <div id="history-list"><p>–í—ã –µ—â–µ –Ω–µ –∑–∞–≤–µ—Ä—à–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏.</p></div>

    <!-- –ë–ª–æ–∫: –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è -->
    <div class="achievements-section">
      <h2>üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
      <div id="achievements-container" class="badges-grid"></div>
    </div>

    <!-- –ë–ª–æ–∫: –í–µ—Å -->
    <div class="weight-section">
      <div class="weight-header">
        <h2>‚öñÔ∏è –î–Ω–µ–≤–Ω–∏–∫ –≤–µ—Å–∞</h2>
        <div class="weight-current" id="current-weight-display">-- <small>–∫–≥</small></div>
      </div>

      <div class="chart-container">
        <canvas id="weightChart"></canvas>
      </div>

      <div class="input-weight-group">
        <input type="number" id="weight-input" class="input-weight" placeholder="–í–µ—Å, –∫–≥" step="0.1">
        <button class="btn-add-weight" onclick="addNewWeight()">OK</button>
      </div>
      <div id="weight-history-list"></div>
    </div>

    <!-- –ö–ù–û–ü–ö–ê –ü–û–î–ï–õ–ò–¢–¨–°–Ø -->
    <div style="padding: 10px 0 30px;">
      <button class="btn-share-result" onclick="shareResults()">
        üöÄ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º
      </button>
    </div>

  </div>

  <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
  <nav class="tab-bar">
    <a href="index.html" class="tab-item">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      <span>Home</span>
    </a>
    <a href="profile.html" class="tab-item active">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      <span>Stats</span>
    </a>
    <a href="info.html" class="tab-item">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>
      <span>Tools</span>
    </a>
  </nav>

  <!-- –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –°–ö–†–ò–ü–¢–û–í -->
  <script src="js/api.js"></script>
  <script src="js/app.js"></script>
  <script src="js/weight.js"></script>
  <script src="js/achievements.js"></script>
  <script src="js/profile.js"></script>

  <script>
    // --- helper: –±–µ–∑–æ–ø–∞—Å–Ω—ã–π JSON.parse
    function safeParse(str, fallback) {
      try { return JSON.parse(str); } catch (e) { return fallback; }
    }

    // --- 1) Bootstrap: –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ —Å Supabase –∏ –ø–æ–ª–æ–∂–∏—Ç—å –≤ localStorage
    async function syncFromSupabaseToLocalStorage() {
      // apiBootstrap –æ–ø—Ä–µ–¥–µ–ª–µ–Ω –≤ js/api.js
      if (typeof apiBootstrap !== 'function') return;

      // initData –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ –≤ Telegram
      const initData = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp.initData : '';
      if (!initData) return;

      const data = await apiBootstrap();

      // userStats
      const stats = data && data.stats ? data.stats : {};
      localStorage.setItem('userStats', JSON.stringify({
        totalWorkouts: Number(stats.total_workouts || 0),
        lastTrainingDate: stats.last_training_at || null,
        // –æ—Å—Ç–∞–≤–∏–º –º–µ—Å—Ç–∞ –ø–æ–¥ –±—É–¥—É—â–∏–µ –ø–æ–ª—è
        steps: safeParse(localStorage.getItem('userStats') || '{}', {}).steps || 0,
        calories: safeParse(localStorage.getItem('userStats') || '{}', {}).calories || 0
      }));

      // trainingHistory ‚Äî –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π —á–∏—Ç–∞–µ—Ç –Ω–∞—à profile.js
      const workouts = Array.isArray(data.workouts) ? data.workouts : [];
      localStorage.setItem('trainingHistory', JSON.stringify(
        workouts.map(w => ({
          date: w.finished_at,
          source: w.source,
          course_id: w.course_id,
          day_index: w.day_index,
          level: w.level,
          payload: w.payload
        }))
      ));

      // weightHistory ‚Äî –ø–æ–¥ weight.js (–æ–±—ã—á–Ω–æ –æ–∂–∏–¥–∞–µ—Ç [{date, weight}, ...])
      const weights = Array.isArray(data.weights) ? data.weights : [];
      // –í Supabase –º—ã –æ—Ç–¥–∞—ë–º –ø–æ —É–±—ã–≤–∞–Ω–∏—é (–Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É) ‚Äî —Ä–∞–∑–≤–µ—Ä–Ω—ë–º –≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—é
      const chronological = weights.slice().reverse().map(x => ({
        date: x.measured_at,
        weight: Number(x.weight)
      }));
      localStorage.setItem('weightHistory', JSON.stringify(chronological));
    }

    // --- 2) –ó–∞–ø—É—Å–∫ UI: –±–µ–∑–æ–ø–∞—Å–Ω–æ, –¥–∞–∂–µ –µ—Å–ª–∏ —á–∞—Å—Ç—å —Ñ—É–Ω–∫—Ü–∏–π –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
    function runUi() {
      if (typeof updateStats === 'function') updateStats();
      if (typeof initWeightSection === 'function') initWeightSection();
      if (typeof renderAchievements === 'function') renderAchievements();
      if (typeof checkAllAchievements === 'function') checkAllAchievements();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // –°–Ω–∞—á–∞–ª–∞ —Å–∏–Ω–∫ (–µ—Å–ª–∏ Telegram + —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞)
        await syncFromSupabaseToLocalStorage();
      } catch (e) {
        console.warn('Supabase bootstrap failed, using local cache:', e);
      } finally {
        // –ü–æ—Ç–æ–º —Ä–∏—Å—É–µ–º UI –∏–∑ localStorage
        runUi();
      }
    });

    // --- –®–ê–†–ò–ù–ì (–∫–∞–∫ —É —Ç–µ–±—è, –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –ª–æ–≥–∏–∫–∏)
    function shareResults() {
      const weightHistory = typeof getWeightHistory === 'function' ? getWeightHistory() : [];
      const stats = safeParse(localStorage.getItem('userStats') || '{}', {});
      const streak = localStorage.getItem('streak') || 0;

      let currentWeight = '--';
      let weightDiffText = '';

      if (weightHistory && weightHistory.length > 0) {
        const start = weightHistory[0].weight;
        const last = weightHistory[weightHistory.length - 1].weight;
        currentWeight = last;

        if (weightHistory.length > 1) {
          const diff = last - start;
          weightDiffText = diff > 0 ? `(+${diff.toFixed(1)} –∫–≥)` : `(${diff.toFixed(1)} –∫–≥)`;
        }
      }

      const message =
`üèÉ‚Äç‚ôÇÔ∏è –ú–æ–π –ø—Ä–æ–≥—Ä–µ—Å—Å –≤ FitGym:

üî• –°–µ—Ä–∏—è: ${streak} –¥–Ω–µ–π
‚öñÔ∏è –í–µ—Å: ${currentWeight} –∫–≥ ${weightDiffText}
üëü –®–∞–≥–æ–≤: ${stats.steps || 0}
‚ö°Ô∏è –ö–∞–ª–æ—Ä–∏–π: ${stats.calories || 0}

–ó–∞–Ω–∏–º–∞–π—Å—è —Å–æ –º–Ω–æ–π! @kagym_bot`;

      if (window.Telegram && window.Telegram.WebApp) {
        const encodedMsg = encodeURIComponent(message);
        const shareUrl = `https://t.me/share/url?url=&text=${encodedMsg}`;
        Telegram.WebApp.openTelegramLink(shareUrl);
        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      } else {
        navigator.clipboard.writeText(message);
        alert('–†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
      }
    }
  </script>
</body>
</html>
