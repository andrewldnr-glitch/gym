<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FitGym</title>

  <link rel="stylesheet" href="css/style.css" />

  <!-- ✅ Единая тема для всего приложения (без "вспышки") -->
  <script src="js/theme.js"></script>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* ===== OPAL Background (глубже, ближе к рефу) ===== */
    body::before{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -2;
      background:
        radial-gradient(980px 760px at 28% 18%, rgba(98,123,255,0.42), transparent 62%),
        radial-gradient(980px 760px at 82% 72%, rgba(186,108,255,0.38), transparent 64%),
        radial-gradient(760px 620px at 58% 44%, rgba(86,206,255,0.16), transparent 66%),
        radial-gradient(1200px 900px at 50% 115%, rgba(0,0,0,0.58), transparent 60%);
      filter: blur(10px);
      transform: translateZ(0);
      animation: opalBg 12s ease-in-out infinite alternate;
    }
    @keyframes opalBg{
      0%   { transform: translate3d(0,0,0) scale(1); filter: blur(10px); }
      100% { transform: translate3d(0,-14px,0) scale(1.07); filter: blur(14px); }
    }

    /* Виньетка + “глубина” как в мокапе */
    body::after{
      content:"";
      position: fixed;
      inset: 0;
      z-index: -1;
      background:
        radial-gradient(1200px 900px at 50% 40%, rgba(255,255,255,0.07), transparent 60%),
        radial-gradient(900px 700px at 50% 78%, rgba(0,0,0,0.50), transparent 62%);
      pointer-events: none;
    }

    /* ===== Home layout ===== */
    .opal-hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      padding-top: 6px;
      padding-bottom: 14px;
    }

    /* Glass upgrade: чуть более “дорого”, как на рефе */
    .opal-card.card{
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 18px 50px rgba(0,0,0,0.22);
    }
    html[data-theme="light"] .opal-card.card{
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(11,16,32,0.08);
      box-shadow: 0 18px 50px rgba(0,0,0,0.10);
    }

    /* ===== Ring ===== */
    .opal-ring-wrap {
      width: 232px;
      height: 232px;
      position: relative;
      display: grid;
      place-items: center;
      margin: 8px auto 2px;
      flex-shrink: 0;
    }

    /* Halo вокруг кольца (Apple-like) */
    .opal-ring-wrap::before{
      content:"";
      position: absolute;
      inset: 18px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 50% 50%,
          rgba(167,139,250,0.26),
          rgba(98,123,255,0.16) 44%,
          transparent 70%);
      filter: blur(12px);
      opacity: 0.85;
      animation: opalHalo 3.8s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes opalHalo{
      0%,100%{ transform: scale(1); opacity: 0.72; }
      50%{ transform: scale(1.045); opacity: 0.95; }
    }

    .opal-ring {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
      display: block;
      filter: drop-shadow(0 26px 48px rgba(124,124,255,0.26));
    }

    .opal-ring-bg {
      fill: none;
      stroke: rgba(255,255,255,0.14);
      stroke-width: 10;
    }
    html[data-theme="light"] .opal-ring-bg { stroke: rgba(11,16,32,0.10); }

    /* ✅ Базовое градиентное кольцо (видно всегда, даже при 0%) */
    .opal-ring-base{
      fill: none;
      stroke: url(#opalRingGrad);
      stroke-width: 10;
      stroke-linecap: round;
      opacity: 0.22;
      filter: url(#opalRingGlow);
    }

    /* Aura слой (шире) — “неон” */
    .opal-ring-glow {
      fill: none;
      stroke: url(#opalRingGrad);
      stroke-width: 14;
      stroke-linecap: round;
      stroke-dasharray: 628;
      stroke-dashoffset: 628;
      opacity: 0.34;
      transition: stroke-dashoffset 650ms ease;
      filter: url(#opalRingGlow);
      animation: opalGlowPulse 3.6s ease-in-out infinite;
    }
    @keyframes opalGlowPulse{
      0%,100%{ opacity: 0.28; }
      50%{ opacity: 0.46; }
    }

    /* Основной прогресс-штрих */
    .opal-ring-fg {
      fill: none;
      stroke: url(#opalRingGrad);
      stroke-width: 10;
      stroke-linecap: round;
      stroke-dasharray: 628;
      stroke-dashoffset: 628;
      transition: stroke-dashoffset 650ms ease;
      filter: url(#opalRingGlow);
    }

    /* Затемнение центра (как в рефе) */
    .opal-ring-center::before{
      content:"";
      position:absolute;
      inset: 52px;
      border-radius: 999px;
      background: radial-gradient(circle at 50% 45%,
        rgba(0,0,0,0.18),
        rgba(0,0,0,0.46) 70%,
        rgba(0,0,0,0.62));
      filter: blur(0.2px);
      opacity: 0.95;
      pointer-events:none;
    }

    .opal-ring-center {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      text-align: center;
      pointer-events: none;
    }

    .opal-ring-center .pct {
      font-size: 3.15rem;
      font-weight: 1000;
      letter-spacing: -1px;
      line-height: 1;
      text-shadow: 0 10px 30px rgba(0,0,0,0.55);
      position: relative; /* поверх затемнения */
    }

    .opal-ring-center .sub {
      margin-top: 6px;
      font-weight: 800;
      font-size: 0.85rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-secondary);
      position: relative;
    }

    /* ===== Cards ===== */
    .opal-grid {
      display: grid;
      gap: 12px;
      width: 100%;
      max-width: 420px;
    }

    .opal-card { padding: 16px; }
    .opal-card-title {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }
    .opal-card-title .label { font-weight: 900; letter-spacing: -0.3px; }
    .opal-card-title .hint  { color: var(--text-secondary); font-weight: 800; font-size: 0.85rem; }

    .opal-kpis { display: grid; gap: 10px; }

    .opal-kpi {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
    }
    html[data-theme="light"] .opal-kpi{
      border-color: rgba(11,16,32,0.08);
      background: rgba(11,16,32,0.03);
    }

    .opal-kpi .k { color: var(--text-secondary); font-weight: 800; font-size: 0.9rem; }
    .opal-kpi .v { font-weight: 1000; letter-spacing: -0.4px; font-size: 1.05rem; }

    .opal-mini-chart{
      width: 100%;
      height: 92px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      overflow: hidden;
      position: relative;
    }
    html[data-theme="light"] .opal-mini-chart{
      border-color: rgba(11,16,32,0.08);
      background: rgba(11,16,32,0.03);
    }
    .opal-mini-chart svg { width: 100%; height: 100%; display: block; }

    /* ===== CTA Buttons ===== */
    .opal-cta{
      display: grid;
      gap: 10px;
      margin-top: 6px;
      width: 100%;
    }

    /* вторичная кнопка под OPAL */
    .btn-ghost{
      width: 100%;
      padding: 16px 18px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.08);
      color: var(--text-primary);
      font-weight: 1000;
      cursor: pointer;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      transition: transform 0.12s ease, filter 0.18s ease, box-shadow 0.18s ease;
      box-shadow: 0 14px 34px rgba(0,0,0,0.18);
    }
    .btn-ghost:active{ transform: scale(0.99); }
    html[data-theme="light"] .btn-ghost{
      border-color: rgba(11,16,32,0.10);
      background: rgba(255,255,255,0.55);
      box-shadow: 0 14px 34px rgba(0,0,0,0.08);
    }

    .opal-cta .btn-main{
      width: 100%;
      font-size: 1.05rem;
      padding: 18px 18px;
    }

    .opal-card.card { cursor: default; }
    .opal-progress-card { overflow: visible; }
  </style>

  <script>
    if (window.Telegram && window.Telegram.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }
  </script>
</head>

<body class="has-tab-bar">
  <div class="container">

    <header class="page-header">
      <div>
        <h1 style="margin-bottom:2px;">FitGym</h1>
        <p style="margin-top:0;">Спокойно. Стабильно. По плану.</p>
      </div>
    </header>

    <section class="opal-hero">
      <!-- Progress Card -->
      <div class="card opal-card opal-progress-card" style="width:100%; max-width:420px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="font-weight:900;">Прогресс</div>
          <div id="opal-progress-hint" style="color:var(--text-secondary); font-weight:800; font-size:0.85rem;">Эта неделя</div>
        </div>

        <!-- Ring -->
        <div class="opal-ring-wrap">
          <svg class="opal-ring" viewBox="0 0 220 220" aria-hidden="true">
            <defs>
              <!-- ✅ Animated rotating gradient -->
              <linearGradient
                id="opalRingGrad"
                x1="0" y1="0" x2="1" y2="1"
                gradientUnits="objectBoundingBox">
                <stop offset="0%"   stop-color="var(--accent-primary)"></stop>
                <stop offset="42%"  stop-color="var(--accent-secondary)"></stop>
                <stop offset="78%"  stop-color="var(--accent-tertiary)"></stop>
                <stop offset="100%" stop-color="var(--accent-primary)"></stop>

                <animateTransform
                  attributeName="gradientTransform"
                  type="rotate"
                  from="0 0.5 0.5"
                  to="360 0.5 0.5"
                  dur="6.2s"
                  repeatCount="indefinite"/>
              </linearGradient>

              <!-- ✅ Glow filter (stronger, cleaner) -->
              <filter id="opalRingGlow" x="-90%" y="-90%" width="280%" height="280%" color-interpolation-filters="sRGB">
                <feGaussianBlur in="SourceGraphic" stdDeviation="7" result="blur"></feGaussianBlur>
                <feColorMatrix
                  in="blur"
                  type="matrix"
                  values="
                    1 0 0 0 0
                    0 1 0 0 0
                    0 0 1 0 0
                    0 0 0 0.72 0"
                  result="glow"></feColorMatrix>
                <feMerge>
                  <feMergeNode in="glow"></feMergeNode>
                  <feMergeNode in="SourceGraphic"></feMergeNode>
                </feMerge>
              </filter>
            </defs>

            <circle class="opal-ring-bg" cx="110" cy="110" r="100"></circle>

            <!-- ✅ Always-on base gradient ring -->
            <circle class="opal-ring-base" cx="110" cy="110" r="100"></circle>

            <!-- ✅ Aura + main progress -->
            <circle id="opal-ring-glow" class="opal-ring-glow" cx="110" cy="110" r="100"></circle>
            <circle id="opal-ring-fg" class="opal-ring-fg" cx="110" cy="110" r="100"></circle>
          </svg>

          <div class="opal-ring-center">
            <div>
              <div id="opal-percent" class="pct">0%</div>
              <div class="sub">цель недели</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cards -->
      <div class="opal-grid">
        <div class="card opal-card">
          <div class="opal-card-title">
            <div class="label">На этой неделе</div>
            <div class="hint" id="opal-week-range">—</div>
          </div>

          <div class="opal-kpis">
            <div class="opal-kpi">
              <div class="k">Активное время</div>
              <div class="v" id="opal-active-time">0m</div>
            </div>
            <div class="opal-kpi">
              <div class="k">Тренировок</div>
              <div class="v" id="opal-workouts">0</div>
            </div>
            <div class="opal-kpi">
              <div class="k">Дней с целью</div>
              <div class="v" id="opal-days">0/7</div>
            </div>
          </div>
        </div>

        <div class="card opal-card">
          <div class="opal-card-title">
            <div class="label">Вес</div>
            <div class="hint" id="opal-weight-last">—</div>
          </div>

          <div class="opal-mini-chart">
            <svg viewBox="0 0 400 92" preserveAspectRatio="none">
              <path id="opal-weight-area" d="" fill="url(#areaGrad)" opacity="0.25"></path>
              <path id="opal-weight-line" d="" fill="none" stroke="url(#lineGrad)" stroke-width="3" stroke-linecap="round"></path>

              <defs>
                <linearGradient id="opalChartGrad" x1="0" y1="0" x2="1" y2="1" gradientUnits="objectBoundingBox">
                  <stop offset="0%" stop-color="var(--accent-secondary)"></stop>
                  <stop offset="55%" stop-color="var(--accent-tertiary)"></stop>
                  <stop offset="100%" stop-color="var(--accent-primary)"></stop>

                  <animateTransform
                    attributeName="gradientTransform"
                    type="rotate"
                    from="0 0.5 0.5"
                    to="360 0.5 0.5"
                    dur="8s"
                    repeatCount="indefinite"></animateTransform>
                </linearGradient>

                <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="var(--accent-tertiary)" stop-opacity="0.85"></stop>
                  <stop offset="100%" stop-color="var(--accent-tertiary)" stop-opacity="0"></stop>
                </linearGradient>

                <linearGradient id="lineGrad" x1="0" y1="0" x2="1" y2="0">
                  <stop offset="0%" stop-color="var(--accent-secondary)"></stop>
                  <stop offset="55%" stop-color="var(--accent-tertiary)"></stop>
                  <stop offset="100%" stop-color="var(--accent-primary)"></stop>
                </linearGradient>
              </defs>
            </svg>
          </div>

          <p style="margin-top:10px; color:var(--text-secondary); font-weight:800; font-size:0.9rem;">
            Добавляй вес — и увидишь тренд.
          </p>
        </div>

        <!-- ✅ CTA: тренировка + курсы -->
        <div class="opal-cta">
          <button class="btn-main" onclick="window.location.href='trainings.html'">Начать тренировку</button>
          <button class="btn-ghost" onclick="window.location.href='courses.html'">Курсы тренировок</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Tab Bar -->
  <nav class="tab-bar">
    <a class="tab-item active" href="index.html">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5z"/>
      </svg>
      Главная
    </a>
    <a class="tab-item" href="profile.html">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 19a8 8 0 0 1 16 0"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      Статистика
    </a>
    <a class="tab-item" href="info.html">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/>
        <circle cx="12" cy="12" r="4"/>
      </svg>
      Инструменты
    </a>
  </nav>

  <script>
    // Helpers
    function startOfWeek(d) {
      const x = new Date(d);
      const day = (x.getDay() + 6) % 7; // Mon=0
      x.setHours(0,0,0,0);
      x.setDate(x.getDate() - day);
      return x;
    }

    function fmtRange(weekStart) {
      const end = new Date(weekStart);
      end.setDate(end.getDate() + 6);
      const opts = { day: 'numeric', month: 'short' };
      return `${weekStart.toLocaleDateString('ru-RU', opts)} – ${end.toLocaleDateString('ru-RU', opts)}`;
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    function loadTrainingHistory() {
      try { return JSON.parse(localStorage.getItem('trainingHistory') || '[]'); }
      catch(_) { return []; }
    }

    function loadWeightHistory() {
      try { return JSON.parse(localStorage.getItem('weightHistory') || '[]'); }
      catch(_) { return []; }
    }

    function updateRing(percent) {
      const circle = document.getElementById('opal-ring-fg');
      const glow = document.getElementById('opal-ring-glow');
      const label = document.getElementById('opal-percent');

      const r = 100;
      const c = 2 * Math.PI * r;

      // ✅ чтобы даже при 0% была микро-дуга (а base ring — всегда видим)
      const p = clamp(percent, 0.8, 100);
      const offset = c * (1 - p/100);

      if (circle) {
        circle.style.strokeDasharray = String(c);
        circle.style.strokeDashoffset = String(offset);
      }
      if (glow) {
        glow.style.strokeDasharray = String(c);
        glow.style.strokeDashoffset = String(offset);
      }
      if (label) label.textContent = `${Math.round(percent)}%`;
    }

    function buildMiniChart(values) {
      const line = document.getElementById('opal-weight-line');
      const area = document.getElementById('opal-weight-area');
      if (!line || !area) return;

      if (!values || values.length < 2) {
        line.setAttribute('d', '');
        area.setAttribute('d', '');
        return;
      }

      const pts = values.slice(-14);
      const w = 400, h = 92;
      const padX = 8, padY = 10;

      const ys = pts.map(p => p.weight);
      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      const span = (maxY - minY) || 1;

      const step = (w - padX*2) / (pts.length - 1);

      const coords = pts.map((p, i) => {
        const x = padX + step * i;
        const norm = (p.weight - minY) / span;
        const y = (h - padY) - norm * (h - padY*2);
        return { x, y };
      });

      const d = coords.map((p,i) => `${i===0?'M':'L'} ${p.x.toFixed(1)} ${p.y.toFixed(1)}`).join(' ');
      line.setAttribute('d', d);

      const dA = `${d} L ${coords[coords.length-1].x.toFixed(1)} ${(h-padY).toFixed(1)} L ${coords[0].x.toFixed(1)} ${(h-padY).toFixed(1)} Z`;
      area.setAttribute('d', dA);
    }

    function initHome() {
      const now = new Date();
      const ws = startOfWeek(now);

      const rangeEl = document.getElementById('opal-week-range');
      if (rangeEl) rangeEl.textContent = fmtRange(ws);

      const hist = loadTrainingHistory();
      const weekItems = hist.filter(x => {
        const dt = new Date(x.date || x.finished_at || Date.now());
        return dt >= ws && dt < new Date(ws.getTime() + 7*24*3600*1000);
      });

      const daysSet = new Set(
        weekItems.map(x => {
          const dt = new Date(x.date || x.finished_at || Date.now());
          return dt.toISOString().slice(0,10);
        })
      );

      const workouts = weekItems.length;
      const days = daysSet.size;

      // пока простая оценка
      const activeMinutes = workouts * 45;
      const hours = Math.floor(activeMinutes / 60);
      const mins = activeMinutes % 60;

      const activeEl = document.getElementById('opal-active-time');
      const workoutsEl = document.getElementById('opal-workouts');
      const daysEl = document.getElementById('opal-days');

      if (activeEl) activeEl.textContent = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
      if (workoutsEl) workoutsEl.textContent = String(workouts);
      if (daysEl) daysEl.textContent = `${days}/7`;

      const WEEK_GOAL = 5;
      const pct = (workouts / WEEK_GOAL) * 100;
      updateRing(pct);

      const weights = loadWeightHistory();
      const last = weights.length ? weights[weights.length-1] : null;
      const wLastEl = document.getElementById('opal-weight-last');
      if (wLastEl) wLastEl.textContent = last ? `${last.weight} кг` : 'Нет данных';

      buildMiniChart(weights);
    }

    document.addEventListener('DOMContentLoaded', initHome);
  </script>
</body>
</html>
