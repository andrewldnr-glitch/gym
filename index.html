<!DOCTYPE html>
<html lang="ru" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>FitGym</title>

  <link rel="stylesheet" href="css/style.css" />

  <!-- ✅ Единая тема для всего приложения (ставим в head, чтобы не было "вспышки") -->
  <script src="js/theme.js"></script>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    /* OPAL Home layout helpers (страница Home) */
    .opal-hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 14px;
      padding-top: 6px;
      padding-bottom: 14px;
    }

    /* ВАЖНО: этот класс ТОЛЬКО для внутреннего контейнера круга */
    .opal-ring-wrap {
      width: 220px;
      height: 220px;
      position: relative;
      display: grid;
      place-items: center;
      margin: 6px auto 2px;
      flex-shrink: 0;
    }

    .opal-ring {
      width: 100%;
      height: 100%;
      transform: rotate(-90deg);
      filter: drop-shadow(0 18px 30px rgba(124,124,255,0.18));
      display: block;
    }

    .opal-ring-bg {
      fill: none;
      stroke: rgba(255,255,255,0.16);
      stroke-width: 10;
    }

    html[data-theme="light"] .opal-ring-bg {
      stroke: rgba(11,16,32,0.10);
    }

    .opal-ring-fg {
      fill: none;
      stroke: url(#opalRingGrad);
      stroke-width: 10;
      stroke-linecap: round;
      stroke-dasharray: 628;
      stroke-dashoffset: 628;
      transition: stroke-dashoffset 600ms ease;
    }

    .opal-ring-center {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      text-align: center;
      pointer-events: none;
    }

    .opal-ring-center .pct {
      font-size: 3.1rem;
      font-weight: 1000;
      letter-spacing: -1px;
      line-height: 1;
    }

    .opal-ring-center .sub {
      margin-top: 6px;
      font-weight: 800;
      font-size: 0.85rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .opal-grid {
      display: grid;
      gap: 12px;
      width: 100%;
      max-width: 420px;
    }

    .opal-card {
      padding: 16px;
    }

    .opal-card-title {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 10px;
    }

    .opal-card-title .label {
      font-weight: 900;
      letter-spacing: -0.3px;
    }

    .opal-card-title .hint {
      color: var(--text-secondary);
      font-weight: 800;
      font-size: 0.85rem;
    }

    .opal-kpis {
      display: grid;
      gap: 10px;
    }

    .opal-kpi {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: rgba(255,255,255,0.06);
    }

    html[data-theme="light"] .opal-kpi {
      background: rgba(11,16,32,0.04);
    }

    .opal-kpi .k {
      color: var(--text-secondary);
      font-weight: 800;
      font-size: 0.9rem;
    }

    .opal-kpi .v {
      font-weight: 1000;
      letter-spacing: -0.4px;
      font-size: 1.05rem;
    }

    .opal-mini-chart {
      width: 100%;
      height: 92px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
      background: rgba(255,255,255,0.06);
      overflow: hidden;
      position: relative;
    }

    html[data-theme="light"] .opal-mini-chart {
      background: rgba(11,16,32,0.04);
    }

    .opal-mini-chart svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    .opal-cta {
      margin-top: 6px;
      width: 100%;
    }

    .opal-cta .btn-main {
      font-size: 1.05rem;
      padding: 18px 18px;
    }

    .opal-card.card {
      cursor: default;
    }

    .opal-progress-card {
      overflow: visible;
    }
  </style>

  <script>
    if (window.Telegram && window.Telegram.WebApp) {
      window.Telegram.WebApp.ready();
      window.Telegram.WebApp.expand();
    }
  </script>
</head>

<body class="has-tab-bar">
  <div class="container">

    <header class="page-header">
      <div>
        <h1 style="margin-bottom:2px;">FitGym</h1>
        <p style="margin-top:0;">Спокойно. Стабильно. По плану.</p>
      </div>
    </header>

    <section class="opal-hero">
      <!-- Progress Card -->
      <div class="card opal-card opal-progress-card" style="width:100%; max-width:420px;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
          <div style="font-weight:900;">Прогресс</div>
          <div id="opal-progress-hint" style="color:var(--text-secondary); font-weight:800; font-size:0.85rem;">Эта неделя</div>
        </div>

        <!-- Ring -->
        <div class="opal-ring-wrap">
          <svg class="opal-ring" viewBox="0 0 220 220" aria-hidden="true">
            <defs>
              <!-- ✅ Gradient for ring (unique id) -->
              <linearGradient id="opalRingGrad" class="opal-grad-anim" x1="0" y1="0" x2="1" y2="1">
                <stop offset="0%" stop-color="var(--accent-primary)"></stop>
                <stop offset="55%" stop-color="var(--accent-secondary)"></stop>
                <stop offset="100%" stop-color="var(--accent-tertiary)"></stop>
              </linearGradient>

              <!-- ✅ Glow filter defined in the same SVG where it is used -->
              <filter id="opalRingGlow" x="-60%" y="-60%" width="220%" height="220%" color-interpolation-filters="sRGB">
                <feGaussianBlur in="SourceGraphic" stdDeviation="4" result="blur"></feGaussianBlur>
                <feColorMatrix
                  in="blur"
                  type="matrix"
                  values="
                    1 0 0 0 0
                    0 1 0 0 0
                    0 0 1 0 0
                    0 0 0 0.85 0"
                  result="glow"></feColorMatrix>
                <feMerge>
                  <feMergeNode in="glow"></feMergeNode>
                  <feMergeNode in="SourceGraphic"></feMergeNode>
                </feMerge>
              </filter>
            </defs>

            <circle class="opal-ring-bg" cx="110" cy="110" r="100"></circle>
            <circle
              id="opal-ring-fg"
              class="opal-ring-fg"
              cx="110" cy="110" r="100"
              filter="url(#opalRingGlow)"></circle>
          </svg>

          <div class="opal-ring-center">
            <div>
              <div id="opal-percent" class="pct">0%</div>
              <div class="sub">цель недели</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Cards -->
      <div class="opal-grid">
        <div class="card opal-card">
          <div class="opal-card-title">
            <div class="label">На этой неделе</div>
            <div class="hint" id="opal-week-range">—</div>
          </div>

          <div class="opal-kpis">
            <div class="opal-kpi">
              <div class="k">Активное время</div>
              <div class="v" id="opal-active-time">0m</div>
            </div>
            <div class="opal-kpi">
              <div class="k">Тренировок</div>
              <div class="v" id="opal-workouts">0</div>
            </div>
            <div class="opal-kpi">
              <div class="k">Дней с целью</div>
              <div class="v" id="opal-days">0/7</div>
            </div>
          </div>
        </div>

        <div class="card opal-card">
          <div class="opal-card-title">
            <div class="label">Вес</div>
            <div class="hint" id="opal-weight-last">—</div>
          </div>

          <div class="opal-mini-chart">
            <svg viewBox="0 0 400 92" preserveAspectRatio="none">
              <path id="opal-weight-area" d="" fill="url(#areaGrad)" opacity="0.25"></path>
              <path id="opal-weight-line" d="" fill="none" stroke="url(#lineGrad)" stroke-width="3" stroke-linecap="round"></path>

              <defs>
                <linearGradient id="opalChartGrad" x1="0" y1="0" x2="1" y2="1" gradientUnits="objectBoundingBox">
                  <stop offset="0%" stop-color="var(--accent-secondary)"></stop>
                  <stop offset="55%" stop-color="var(--accent-tertiary)"></stop>
                  <stop offset="100%" stop-color="var(--accent-primary)"></stop>

                  <animateTransform
                    attributeName="gradientTransform"
                    type="rotate"
                    from="0 0.5 0.5"
                    to="360 0.5 0.5"
                    dur="8s"
                    repeatCount="indefinite"></animateTransform>
                </linearGradient>

                <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
                  <stop offset="0%" stop-color="var(--accent-tertiary)" stop-opacity="0.85"></stop>
                  <stop offset="100%" stop-color="var(--accent-tertiary)" stop-opacity="0"></stop>
                </linearGradient>

                <linearGradient id="lineGrad" x1="0" y1="0" x2="1" y2="0">
                  <stop offset="0%" stop-color="var(--accent-secondary)"></stop>
                  <stop offset="55%" stop-color="var(--accent-tertiary)"></stop>
                  <stop offset="100%" stop-color="var(--accent-primary)"></stop>
                </linearGradient>
              </defs>
            </svg>
          </div>

          <p style="margin-top:10px; color:var(--text-secondary); font-weight:800; font-size:0.9rem;">
            Добавляй вес — и увидишь тренд.
          </p>
        </div>

        <div class="opal-cta">
          <button class="btn-main" onclick="window.location.href='trainings.html'">Начать тренировку</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Tab Bar -->
  <nav class="tab-bar">
    <a class="tab-item active" href="index.html">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 10.5 12 3l9 7.5V21a1 1 0 0 1-1 1h-5v-7H9v7H4a1 1 0 0 1-1-1v-10.5z"/>
      </svg>
      Главная
    </a>
    <a class="tab-item" href="profile.html">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M4 19a8 8 0 0 1 16 0"/>
        <circle cx="12" cy="7" r="4"/>
      </svg>
      Статистика
    </a>
    <a class="tab-item" href="info.html">
      <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/>
        <circle cx="12" cy="12" r="4"/>
      </svg>
      Инструменты
    </a>
  </nav>

  <script>
    // -----------------------------
    // Helpers
    // -----------------------------
    function startOfWeek(d) {
      const x = new Date(d);
      const day = (x.getDay() + 6) % 7; // Mon=0
      x.setHours(0,0,0,0);
      x.setDate(x.getDate() - day);
      return x;
    }

    function fmtRange(weekStart) {
      const end = new Date(weekStart);
      end.setDate(end.getDate() + 6);
      const opts = { day: 'numeric', month: 'short' };
      return `${weekStart.toLocaleDateString('ru-RU', opts)} – ${end.toLocaleDateString('ru-RU', opts)}`;
    }

    function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

    // -----------------------------
    // Data loaders
    // -----------------------------
    function loadTrainingHistory() {
      try {
        return JSON.parse(localStorage.getItem('trainingHistory') || '[]');
      } catch(_) { return []; }
    }

    function loadWeightHistory() {
      try {
        return JSON.parse(localStorage.getItem('weightHistory') || '[]');
      } catch(_) { return []; }
    }

    // -----------------------------
    // UI updates
    // -----------------------------
    function updateRing(percent) {
      const circle = document.getElementById('opal-ring-fg');
      const label = document.getElementById('opal-percent');
      const r = 100;
      const c = 2 * Math.PI * r;
      const p = clamp(percent, 0, 100);
      const offset = c * (1 - p/100);
      if (circle) {
        circle.style.strokeDasharray = String(c);
        circle.style.strokeDashoffset = String(offset);
      }
      if (label) label.textContent = `${Math.round(p)}%`;
    }

    function buildMiniChart(values) {
      const line = document.getElementById('opal-weight-line');
      const area = document.getElementById('opal-weight-area');
      if (!line || !area) return;

      if (!values || values.length < 2) {
        line.setAttribute('d', '');
        area.setAttribute('d', '');
        return;
      }

      const pts = values.slice(-14);

      const w = 400, h = 92;
      const padX = 8, padY = 10;

      const ys = pts.map(p => p.weight);
      const minY = Math.min(...ys);
      const maxY = Math.max(...ys);
      const span = (maxY - minY) || 1;

      const step = (w - padX*2) / (pts.length - 1);

      const coords = pts.map((p, i) => {
        const x = padX + step * i;
        const norm = (p.weight - minY) / span;
        const y = (h - padY) - norm * (h - padY*2);
        return { x, y };
      });

      const d = coords.map((p,i) => `${i===0?'M':'L'} ${p.x.toFixed(1)} ${p.y.toFixed(1)}`).join(' ');
      line.setAttribute('d', d);

      const dA = `${d} L ${coords[coords.length-1].x.toFixed(1)} ${(h-padY).toFixed(1)} L ${coords[0].x.toFixed(1)} ${(h-padY).toFixed(1)} Z`;
      area.setAttribute('d', dA);
    }

    function initHome() {
      const now = new Date();
      const ws = startOfWeek(now);

      const rangeEl = document.getElementById('opal-week-range');
      if (rangeEl) rangeEl.textContent = fmtRange(ws);

      const hist = loadTrainingHistory();
      const weekItems = hist.filter(x => {
        const dt = new Date(x.date || x.finished_at || Date.now());
        return dt >= ws && dt < new Date(ws.getTime() + 7*24*3600*1000);
      });

      const daysSet = new Set(
        weekItems.map(x => {
          const dt = new Date(x.date || x.finished_at || Date.now());
          return dt.toISOString().slice(0,10);
        })
      );

      const workouts = weekItems.length;
      const days = daysSet.size;

      // простая оценка, потом можно заменить на реальные метрики
      const activeMinutes = workouts * 45;
      const hours = Math.floor(activeMinutes / 60);
      const mins = activeMinutes % 60;

      const activeEl = document.getElementById('opal-active-time');
      const workoutsEl = document.getElementById('opal-workouts');
      const daysEl = document.getElementById('opal-days');

      if (activeEl) activeEl.textContent = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
      if (workoutsEl) workoutsEl.textContent = String(workouts);
      if (daysEl) daysEl.textContent = `${days}/7`;

      const WEEK_GOAL = 5;
      const pct = (workouts / WEEK_GOAL) * 100;
      updateRing(pct);

      const weights = loadWeightHistory();
      const last = weights.length ? weights[weights.length-1] : null;
      const wLastEl = document.getElementById('opal-weight-last');
      if (wLastEl) wLastEl.textContent = last ? `${last.weight} кг` : 'Нет данных';

      buildMiniChart(weights);
    }

    document.addEventListener('DOMContentLoaded', initHome);
  </script>
</body>
</html>
